name: Sync locales to target repository after checks

on:
  push:
    paths:
      - 'locales/**'
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write

jobs:
  wait-for-checks:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.set.outputs.sha }}
    steps:
      - name: Set commit SHA
        id: set
        run: echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Wait for combined status to be success
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # PAT or `GITHUB_TOKEN`. Required to query combined commit status via REST API; PAT should have `repo` scope for private repos.
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python - <<'PY'
          import os, sys, time, json
          from urllib.request import Request, urlopen
          token = os.environ.get('PERSONAL_ACCESS_TOKEN') or os.environ.get('GITHUB_TOKEN')
          if not token:
            print('No token available')
            sys.exit(1)
          repo = os.environ['GITHUB_REPOSITORY']
          sha = os.environ['GITHUB_SHA']
          headers = {'Authorization': f'token {token}', 'Accept': 'application/vnd.github+json'}
          timeout = 60 * 15
          interval = 15
          elapsed = 0
          url = f'https://api.github.com/repos/{repo}/commits/{sha}/status'
          while elapsed < timeout:
            req = Request(url, headers=headers)
            with urlopen(req) as r:
              data = json.load(r)
            state = data.get('state')
            print('combined state:', state)
            if state == 'success':
              sys.exit(0)
            if state == 'failure':
              print('Checks failed')
              sys.exit(2)
            time.sleep(interval)
            elapsed += interval
          print('Timed out waiting for checks')
          sys.exit(3)
          PY

  sync-locales:
    needs: wait-for-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.TARGET_REPOSITORY }} # owner/repo (format: "owner/name") destination to sync locales into
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # PAT with `repo` scope used to push branches or create PRs on the target repo
          path: target
          fetch-depth: 0

      - name: Sync locales
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # PAT used for pushing branches/creating PRs on target repo
          TARGET_REPOSITORY: ${{ secrets.TARGET_REPOSITORY }} # owner/repo string for target (format: "owner/name")
          DIRECT_PUSH: ${{ secrets.DIRECT_PUSH }} # if "true", workflow will push directly to default branch; otherwise it will open a PR
        run: |
          set -euo pipefail
          OWNER_REPO=${TARGET_REPOSITORY}
          OWNER=$(echo $OWNER_REPO | cut -d/ -f1)
          REPO=$(echo $OWNER_REPO | cut -d/ -f2)

          # Get default branch of target repo
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${PERSONAL_ACCESS_TOKEN}" https://api.github.com/repos/${OWNER_REPO} | python -c "import sys,json; print(json.load(sys.stdin)['default_branch'])")

          cd target
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${DIRECT_PUSH:-false}" = "true" ]; then
            git fetch origin ${DEFAULT_BRANCH}:${DEFAULT_BRANCH} || true
            git checkout ${DEFAULT_BRANCH} || git checkout -b ${DEFAULT_BRANCH}
            rsync -av --delete ../locales/ ./locales/
            git add --all locales
            if git diff --cached --quiet --; then
              echo "No changes to sync"
            else
              git commit -m "chore: sync locales from ${{ github.repository }}"
              git remote set-url origin https://x-access-token:${PERSONAL_ACCESS_TOKEN}@github.com/${OWNER_REPO}
              git push origin HEAD:${DEFAULT_BRANCH}
              echo "Pushed locales to ${OWNER_REPO}:${DEFAULT_BRANCH}"
            fi
          else
            BRANCH=sync-locales-$(date -u +%Y%m%d%H%M%S)
            git checkout -b $BRANCH origin/${DEFAULT_BRANCH} || git checkout -b $BRANCH
            rsync -av --delete ../locales/ ./locales/
            git add --all locales
            if git diff --cached --quiet --; then
              echo "No changes to sync"
            else
              git commit -m "chore: sync locales from ${{ github.repository }}"
              git remote set-url origin https://x-access-token:${PERSONAL_ACCESS_TOKEN}@github.com/${OWNER_REPO}
              git push -u origin $BRANCH

              PR_JSON=$(jq -n --arg title "chore: sync locales from ${{ github.repository }}" --arg head "$BRANCH" --arg base "$DEFAULT_BRANCH" '{title:$title, head:$head, base:$base}')
              PR_RESPONSE=$(curl -s -H "Authorization: token ${PERSONAL_ACCESS_TOKEN}" -H "Accept: application/vnd.github+json" -d "$PR_JSON" https://api.github.com/repos/${OWNER_REPO}/pulls)
              echo "$PR_RESPONSE"
            fi
          fi
