name: Push locales changes back to source repository

on:
  push:
    paths:
      - 'locales/**'
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write

jobs:
  wait-for-checks:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.set.outputs.sha }}
    steps:
      - name: Set commit SHA
        id: set
        run: echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Wait for combined status to be success
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python - <<'PY'
import os, sys, time, json
from urllib.request import Request, urlopen
token = os.environ.get('PERSONAL_ACCESS_TOKEN') or os.environ.get('GITHUB_TOKEN')
if not token:
    print('No token available')
    sys.exit(1)
repo = os.environ['GITHUB_REPOSITORY']
sha = os.environ['GITHUB_SHA']
headers = {'Authorization': f'token {token}', 'Accept': 'application/vnd.github+json'}
timeout = 60 * 15
interval = 15
elapsed = 0
url = f'https://api.github.com/repos/{repo}/commits/{sha}/status'
while elapsed < timeout:
    req = Request(url, headers=headers)
    with urlopen(req) as r:
        data = json.load(r)
    state = data.get('state')
    print('combined state:', state)
    if state == 'success':
        sys.exit(0)
    if state == 'failure':
        print('Checks failed')
        sys.exit(2)
    time.sleep(interval)
    elapsed += interval
print('Timed out waiting for checks')
sys.exit(3)
PY
  sync-to-source:
    needs: wait-for-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.SOURCE_REPOSITORY }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: source
          fetch-depth: 0

      - name: Sync locales into source repo (PR or direct push)
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          SOURCE_REPOSITORY: ${{ secrets.SOURCE_REPOSITORY }}
          DIRECT_PUSH: ${{ secrets.DIRECT_PUSH }}
        run: |
          set -euo pipefail
          OWNER_REPO=${SOURCE_REPOSITORY}
          OWNER=$(echo $OWNER_REPO | cut -d/ -f1)
          REPO=$(echo $OWNER_REPO | cut -d/ -f2)

          # Determine default branch of source repo
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${PERSONAL_ACCESS_TOKEN}" https://api.github.com/repos/${OWNER_REPO} | python -c "import sys, json; print(json.load(sys.stdin)['default_branch'])")

          cd source
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # If DIRECT_PUSH is set to "true", push changes directly to the default branch (no PR).
          if [ "${DIRECT_PUSH:-false}" = "true" ]; then
            git fetch origin ${DEFAULT_BRANCH}:${DEFAULT_BRANCH} || true
            git checkout ${DEFAULT_BRANCH} || git checkout -b ${DEFAULT_BRANCH}

            rsync -av --delete ../locales/ ./locales/

            if [ -n "$(git status --porcelain)" ]; then
              git add locales
              git commit -m "chore: sync locales from ${{ github.repository }}"
              git remote set-url origin https://x-access-token:${PERSONAL_ACCESS_TOKEN}@github.com/${OWNER_REPO}
              git push origin HEAD:${DEFAULT_BRANCH}
              echo "Pushed changes directly to ${OWNER_REPO}:${DEFAULT_BRANCH}"
            else
              echo "No changes to sync"
            fi
          else
            BRANCH=sync-locales-to-source-$(date -u +%Y%m%d%H%M%S)
            git checkout -b $BRANCH origin/${DEFAULT_BRANCH} || git checkout -b $BRANCH

            # Sync locales from workspace into source repo
            rsync -av --delete ../locales/ ./locales/

            if [ -n "$(git status --porcelain)" ]; then
              git add locales
              git commit -m "chore: sync locales from ${{ github.repository }}"
              git remote set-url origin https://x-access-token:${PERSONAL_ACCESS_TOKEN}@github.com/${OWNER_REPO}
              git push -u origin $BRANCH

              # Create Pull Request on source repo
              PR_BODY=$(cat <<EOF
Automated sync of `locales/` from ${{ github.repository }}.
If everything looks good, merge this PR to apply updates.
EOF
)
              PR_JSON=$(jq -n --arg title "chore: sync locales from ${{ github.repository }}" --arg head "$BRANCH" --arg base "$DEFAULT_BRANCH" --arg body "$PR_BODY" '{title:$title, head:$head, base:$base, body:$body}')
              PR_RESPONSE=$(curl -s -H "Authorization: token ${PERSONAL_ACCESS_TOKEN}" -H "Accept: application/vnd.github+json" -d "$PR_JSON" https://api.github.com/repos/${OWNER_REPO}/pulls)
              PR_NUMBER=$(echo "$PR_RESPONSE" | python - <<'PY'
import sys, json
o=json.load(sys.stdin)
print(o.get('number',''))
PY
)

              if [ -n "$PR_NUMBER" ]; then
                # Enable auto-merge (squash)
                curl -s -X PUT -H "Authorization: token ${PERSONAL_ACCESS_TOKEN}" -H "Accept: application/vnd.github+json" -d '{"merge_method":"squash"}' https://api.github.com/repos/${OWNER_REPO}/pulls/${PR_NUMBER}/enable-auto-merge
                echo "Created PR #$PR_NUMBER in ${OWNER_REPO}"
              else
                echo "Failed to create PR:" >&2
                echo "$PR_RESPONSE" >&2
                exit 1
              fi
            else
              echo "No changes to sync"
            fi
          fi
